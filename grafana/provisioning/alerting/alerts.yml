apiVersion: 1

contactPoints:
  - orgId: 1
    name: default
    receivers:
      - uid: claude-code-email
        type: email
        settings:
          addresses: pedroguimaraes@ravn.co
          singleEmail: false

policies:
  - orgId: 1
    receiver: default
    groupBy:
      - grafana_folder
      - alertname
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 4h

groups:
  - orgId: 1
    name: cost_alerts
    folder: Claude Code Alerts
    interval: 60s
    rules:
      # Alert: Daily cost exceeds threshold
      - uid: claude-daily-cost-high
        title: Daily Cost High
        condition: B
        for: 0s
        noDataState: OK
        execErrState: OK
        annotations:
          summary: Daily Claude Code cost exceeded threshold
          description: "Daily cost is {{ $values.A.Value | printf \"%.2f\" }} USD"
        labels:
          severity: warning
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 86400
              to: 0
            model:
              expr: sum(increase(claude_code_cost_usage_USD_total[24h]))
              instant: true
              range: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            datasourceUid: "__expr__"
            relativeTimeRange:
              from: 0
              to: 0
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 10
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    type: last
              refId: B

      # Alert: Spending rate exceeds $5/hour
      - uid: claude-spending-rate-high
        title: Spending Rate High
        condition: B
        for: 5m
        noDataState: OK
        execErrState: OK
        annotations:
          summary: Claude Code spending rate is high
          description: "Spending rate is {{ $values.A.Value | printf \"%.2f\" }} USD/hour"
        labels:
          severity: critical
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 600
              to: 0
            model:
              expr: sum(rate(claude_code_cost_usage_USD_total[5m])) * 3600
              instant: true
              range: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            datasourceUid: "__expr__"
            relativeTimeRange:
              from: 0
              to: 0
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 5
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    type: last
              refId: B

      # Alert: Single session cost exceeds threshold
      - uid: claude-session-cost-high
        title: Session Cost High
        condition: B
        for: 0s
        noDataState: OK
        execErrState: OK
        annotations:
          summary: A single Claude Code session exceeded cost threshold
          description: "Session cost is {{ $values.A.Value | printf \"%.2f\" }} USD"
        labels:
          severity: warning
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 86400
              to: 0
            model:
              expr: max(max by (session_id) (max_over_time(claude_code_cost_usage_USD_total[24h])))
              instant: true
              range: false
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            datasourceUid: "__expr__"
            relativeTimeRange:
              from: 0
              to: 0
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 5
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    type: last
              refId: B
